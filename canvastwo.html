<!DOCTYPE html>
<!-- 
MAPPLICATION development team is:
Rob Shepard, GIS Specialist 
Matthew Butler, Senior Developer
Ethan Degross, Researcher/Developer

Parts of this code were derived from the original work of Jessica Dussault, Programmer, University of Nebraska Center for Digital Research in the Humanities

University of Iowa Libraries Digital Scholarship and Publishing Studio
This work is released under Creative Commons Attribution-NonCommercial-ShareAlike License 2018
CC BY-NC-SA


-->
<html>
  <head>
    <title>$title</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- INCLUDES -->
      <!-- include leaflet / slider css, js local files -->
      <script src="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.3/leaflet-src.js"></script>
      <link rel="stylesheet" href="public/leaflet-1/leaflet.css" />
	  <!--OLD LINK IS HERE - <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.3/leaflet.css" /> -->
      <script src="public/leafletSlider-1.0.2/leaflet.SliderControl.min.js"></script>
      <!-- include a pretty little stamenizer -->
      <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
      <!-- Add Fuse code first, then add the leaflet plugins that use fuse searching -->
      <script src="public/fuse-1.2.1/fuse.min.js"></script>
      <script src="public/leafletFuseSearch-noVersion/leafletfuse.js"></script>
      <link rel="stylesheet" href="public/leafletFuseSearch-noVersion/leafletfuse.css" type="text/css"/>
      <!-- jquery and css -->
      <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
      <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
      <!-- Include this library for mobile touch support -->
      <script src="public/jqueryUiTouchPunch-0.2.2/jquery.ui.touch-punch.min.js"></script>
	    <!-- Load Esri Leaflet from CDN -->
  <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.2/esri-leaflet.js"></script>
      <!-- JSON points referneced here - supports up to four layers now but we'll probably expand-->
      <script src="$mainlayer.js"></script>

	  <link rel="stylesheet" type="text/css" href="css/style.css">
	  <link rel="stylesheet" type="text/css" href="css/navwrap.css">
	  	  <style type="text/css">
	  
	    #map {
            width: 100%;
            height: 100%;
			left: 1px;

			position: absolute;
        }

		</style>
	  
	  
	  
  </head>


  <body>


    <!-- provide the map with a div to live inside -->
    <div id="map" style="width: 100%; height: 900px; position: absolute"></div>

    <script>
      // set up with openstreetmaps
	  
	  	  var myIcon = L.icon({
    iconUrl: 'my-icon.png',
    iconRetinaUrl: 'my-icon@2x.png',
    iconSize: [1, 1],
    iconAnchor: [1, 1],
    popupAnchor: [-1, -1]
});
	  
//TOLD CODE, SETS JUST THE BASE MAP WITHOUT OTHER BASE LAYERS	 
//      var map = L.map('map').setView(new L.LatLng(41.259944, -95.937057), 15);
	  
      // gets custom base map
// L.esri.tiledMapLayer({
//    url: "https://gis.lib.uiowa.edu/gislib1/rest/services/Rob/omabase/MapServer"
//  }).addTo(map);
//AND YOU CAN UNCOMMENT DOWN TO HERE TO REACTIVATE, BUT WHY

	 var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>'; 
	  
//here I use an esri tiled WMS layer, a tiled layer out on mapbox, and a GeoServer tiled map service. This is really for my own reference... PS the commas and "names = " stuff replaces variables. You call up all the layers in one spot
	  //These options should be in the boilerplate? But the actual variable selected becomes the $basemap brought into the map (e.g. if user picks "grayscale" then $basemap = var grayscale)
	 var blanktile =  L.esri.tiledMapLayer({url: "https://services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"}),
	 grayscale = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmNzaGVwYXJkIiwiYSI6IjYwYjI0NzdmNDQwM2YzNTc1ODI2NWZhNTU1ZTVmNjY4In0.ct_UnOxwtV_WIGwzyG0Rxw', {id: 'mapbox.light', attribution: mbAttr}),
	 dark = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmNzaGVwYXJkIiwiYSI6IjYwYjI0NzdmNDQwM2YzNTc1ODI2NWZhNTU1ZTVmNjY4In0.ct_UnOxwtV_WIGwzyG0Rxw', {id: 'mapbox.dark', attribution: mbAttr}),
	 opengeo = L.tileLayer.wms('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),
	 stamenbackground = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.{ext}', {
	attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
	subdomains: 'abcd',
	minZoom: 0,
	maxZoom: 18,
	ext: 'png'
}),
	 stamenmap = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
	attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
	subdomains: 'abcd',
	minZoom: 0,
	maxZoom: 18,
	ext: 'png'
});
	 
//	 var stamenUrl = "http://{S}tile.stamen.com/terrain/{Z}/{X}/{Y}.png";

//var mstamenurl = stamenUrl.replace(/({[A-Z]})/g, function(s) {
//    return s.toLowerCase();
//});
	 
	 //Get $centerlat and $centerlong and $zoom from little map app window
	 //User selects a $basemap from the list of options in "other" javascript
	 
      var map = L.map('map', {
	  center: [$centerlat, $centerlong],
	  zoom: 2
	  layers: [$basemap] 
	  });
	  


      // original open street maps tiles, remove above few lines and uncomment these
      /*L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);*/

      // onEachFeature generate a popup for each location
      // those params are coming automatically from the geoJson method
      var onEachFeature = function(feature, layer) {
        if (feature.properties) {
          var prop = feature.properties;
          // make html popup with properties. This example allows up to 3 text fields (1 title), a URL field, and a Photo, if included in the
            var popup = '<h3>'+prop['$FIELD1']'</h3>'+'$FIELD2: '+prop['$FIELD2']+'<br>'+'FIELD3: '+prop['FIELD3']+'<br>'+'Reason lost: '+prop['REASON']+'<br><strong>Link to Story: </strong><a href='+prop['LINKFIELD']+'>'+prop['LINKFIELD']+'</a><br>'+'<img src='+' height=\"300\" width=\"300\">';
            // add known info about event to the description
          
          // you must create a layer property on each feature or else
          // the search results won't know where the item is on the map / layer
          feature.layer = layer;
          layer.bindPopup(popup, {maxWidth: "auto"});
        }
      }; // end onEachFeature

      // Defining various types of marker colors here. Example: If user picks "red" for a layer, the variable will be set to "redCircleMarkers". Circlemarkers is left for semi-transparent/ search layers
      var blueCircleMarkers = {
        radius: 7,
        fillColor: "#00AEEF",
        color: "#3978BF",
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.5
      };
	  
	  var CircleMarkers = {
        radius: 7,
        fillColor: "#000000",
        color: "#000000",
        weight: 1,
        opacity: 0.1,
        fillOpacity: 0.1
      };

      var redCircleMarkers = {
        radius: 7,
        fillColor: "#ED1C24",
        color: "#ED1C24",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      };

      var purpleCircleMarkers = {
        radius: 7,
        fillColor: "#551a8b",
        color: "#000000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      };
	  
	  var yellowCircleMarkers = {
	  radius: 7,
        fillColor: "#ffff00",
        color: "#000000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      };
	  
	  var greenCircleMarkers = {
        radius: 7,
        fillColor: "#00cc00",
        color: "#000000",
        weight: 1,
        opacity: 0.5,
        fillOpacity: 0.5
      };

      // generate a layer of markers for all the locations
 //    L.geoJson($mainlayer, {
        // add popups
 //       onEachFeature: onEachFeature,
 //       pointToLayer: function(feature, latlng) {
//          return L.circleMarker(latlng, CircleMarkers);
//        }
//     }).addTo(map);
	  
       //now make a timeline layer that the slider can manipulate - REMOVED
      var timelineLayer = L.geoJson($mainlayer, {
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, redCircleMarkers);
        }
      });

      // make a search layer
      // now make a timeline layer that the slider can manipulate
      var searchLayer = L.geoJson($mainlayer, {
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, CircleMarkers);
        }
      });
	  
       searchLayer.addTo(map);

      // create the slider   - REMOVED
      var sliderControl = L.control.sliderControl({
          position: "topright",
          layer: timelineLayer,
          range: true // gives it a bottom and a top slider
      });

 //     map.addControl(sliderControl);
  //    sliderControl.startSlider(); // initialize

      // Add fuse search control
      var searchOptions = {
        position: 'topleft',
        title: 'Search',
        placeholder: 'Type here',
        maxResultLength: 10,
        caseSensitive: false,
        showInvisibleFeatures: true,
        layerToToggle: searchLayer,
        threshold: 0.5, // default is .5, will match imperfect results
        showResultFct: function(feature, container) {
          props = feature.properties;
          var name = L.DomUtil.create('b', null, container);
          name.innerHTML = props.$searchfield;

          container.appendChild(L.DomUtil.create('br', null, container));

          var cat = props.$searchfield ? props.$searchfield2 : props.$searchfield,
              info = cat;
          container.appendChild(document.createTextNode(info));
        }
      };
      var searchControl = L.control.fuseSearch(searchOptions);
      map.addControl(searchControl);
      searchControl.indexFeatures($mainlayer, ['$searchfield']);

      displayFeatures($mainlayer, searchLayer);

      function displayFeatures(features, layer) {
        var popup = L.DomUtil.create('div', 'tiny-popup', map.getContainer());
        for (var id in features) {
          var feat = features[id];
          var cat = feat.properties.NAME;
          var site = L.geoJson(feat, {
            pointToLayer: function(feature, latLng) {
              var marker = L.marker(latLng, {
			    icon: myIcon,
                keyboard: false,
                riseOnHover: true
              });
              if (! L.touch) {
                marker.on('mouseover', function(position) {
                  // TODO can put text in here when hovering search
                  // popup.innerHTML = 'Testing';
                  // L.DomUtil.setPosition(popup, pos);
                  // L.DomUtil.addClass(popup, 'visible');
                }).on('mouseout', function(position) {
                  L.DomUtil.removeClass(popup, 'visible');
                });
              }
              return marker;
            },
            onEachFeature: onEachFeature
          });
          if (layer !== undefined) {
              layer.addLayer(site);
          }
        }
        return layer;
      };
	  //adds a layer for some other geojson, just change out "nashpeople" with another file
	  
//	    var grayscale = L.tileLayer(mbUrl, {id: 'mapbox.mapbox-terrain-v2', attribution: mbAttr});

	 var $mainlayer = new L.geoJson($mainlayer, {
	  onEachFeature: onEachFeature,
pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, $markercolor);
    }}).addTo(map);
	
	  var bounds = L.latLngBounds($mainlayer);
      map.fitBounds($mainlayer.getBounds());
	  
//	  		var baseLayers = {
//			"Dark": grayscale
//		};
	  
	  		var overlays = {
			"$mainlayer": $mainlayer
	  };
	  
			var baseMaps = {
			"<strong>Layer List</strong>": $basemap
//			"Modern Map": grayscale,
//			"opengeo": opengeo
			};
	  
	  L.control.layers(baseMaps, overlays, {collapsed:false}).addTo(map);

    </script>
	
  </body>
</html>